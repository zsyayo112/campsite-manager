# 批次3：核心CRUD功能

## 批次概述

实现营地套餐管理、预订管理和客户信息管理的完整CRUD（增删改查）功能。

## 任务清单

### 1. 数据模型扩展

- [ ] 扩展 Prisma Schema
  - [ ] 营地套餐表（packages）

    ```prisma
    model Package {
      id          String    @id @default(cuid())
      name        String
      description String?
      price       Decimal
      duration    Int       // 天数
      capacity    Int       // 可容纳人数
      amenities   String[]  // 设施列表
      images      String[]  // 图片URLs
      status      PackageStatus @default(ACTIVE)
      created_at  DateTime  @default(now())
      updated_at  DateTime  @updatedAt
      bookings    Booking[]
    }

    enum PackageStatus {
      ACTIVE
      INACTIVE
      DRAFT
    }
    ```

  - [ ] 预订表（bookings）

    ```prisma
    model Booking {
      id             String        @id @default(cuid())
      user_id        String
      package_id     String
      check_in       DateTime
      check_out      DateTime
      guest_count    Int
      total_price    Decimal
      status         BookingStatus @default(PENDING)
      special_requests String?
      created_at     DateTime      @default(now())
      updated_at     DateTime      @updatedAt

      user           User          @relation(fields: [user_id], references: [id])
      package        Package       @relation(fields: [package_id], references: [id])
      guests         Guest[]
    }

    enum BookingStatus {
      PENDING
      CONFIRMED
      CHECKED_IN
      CHECKED_OUT
      CANCELLED
    }
    ```

  - [ ] 客户信息表（guests）
    ```prisma
    model Guest {
      id                String  @id @default(cuid())
      booking_id        String
      name              String
      age               Int?
      phone             String?
      emergency_contact String?
      emergency_phone   String?
      dietary_requirements String?
      created_at        DateTime @default(now())
      updated_at        DateTime @updatedAt

      booking           Booking @relation(fields: [booking_id], references: [id])
    }
    ```
- [ ] 运行数据库迁移
- [ ] 创建种子数据

### 2. 营地套餐管理系统

#### API 端点实现

- [ ] 套餐列表 API
  - [ ] `src/app/api/packages/route.js` (GET)
  - [ ] 支持分页、搜索、过滤
  - [ ] 按价格、容量、状态过滤
  - [ ] 支持排序（价格、创建时间等）
- [ ] 创建套餐 API
  - [ ] `src/app/api/packages/route.js` (POST)
  - [ ] 输入验证和清理
  - [ ] 管理员权限检查
  - [ ] 图片上传处理（暂时用URL）
- [ ] 套餐详情 API
  - [ ] `src/app/api/packages/[id]/route.js` (GET)
  - [ ] 包含预订统计信息
- [ ] 更新套餐 API
  - [ ] `src/app/api/packages/[id]/route.js` (PUT)
  - [ ] 部分更新支持
  - [ ] 版本冲突检查
- [ ] 删除套餐 API
  - [ ] `src/app/api/packages/[id]/route.js` (DELETE)
  - [ ] 软删除或状态更新
  - [ ] 检查是否有关联预订

#### 前端页面实现

- [ ] 套餐列表页面 `src/app/packages/page.js`
  - [ ] 网格布局展示套餐卡片
  - [ ] 搜索和过滤功能
  - [ ] 分页组件
  - [ ] 新建套餐按钮（管理员可见）
- [ ] 添加套餐页面 `src/app/packages/add/page.js`
  - [ ] 表单验证
  - [ ] 图片预览功能
  - [ ] 设施选择器
  - [ ] 实时价格预览
- [ ] 编辑套餐页面 `src/app/packages/[id]/edit/page.js`
  - [ ] 预填充现有数据
  - [ ] 编辑历史记录（可选）
- [ ] 套餐详情页面 `src/app/packages/[id]/page.js`
  - [ ] 完整信息展示
  - [ ] 预订按钮
  - [ ] 相关推荐

### 3. 预订管理系统

#### API 端点实现

- [ ] 预订列表 API
  - [ ] `src/app/api/bookings/route.js` (GET)
  - [ ] 按用户、状态、日期过滤
  - [ ] 支持管理员查看所有预订
- [ ] 创建预订 API
  - [ ] `src/app/api/bookings/route.js` (POST)
  - [ ] 日期冲突检查
  - [ ] 容量验证
  - [ ] 价格计算
  - [ ] 自动状态管理
- [ ] 预订详情 API
  - [ ] `src/app/api/bookings/[id]/route.js` (GET)
  - [ ] 包含套餐和客户信息
- [ ] 更新预订状态 API
  - [ ] `src/app/api/bookings/[id]/status/route.js` (PUT)
  - [ ] 状态流转验证
  - [ ] 自动通知功能
- [ ] 取消预订 API
  - [ ] `src/app/api/bookings/[id]/cancel/route.js` (PUT)
  - [ ] 取消政策检查
  - [ ] 退款处理逻辑

#### 前端页面实现

- [ ] 预订列表页面 `src/app/bookings/page.js`
  - [ ] 表格形式展示
  - [ ] 状态筛选器
  - [ ] 日期范围选择器
  - [ ] 快速操作按钮
- [ ] 新建预订页面 `src/app/bookings/new/page.js`
  - [ ] 套餐选择器
  - [ ] 日期选择器（日历组件）
  - [ ] 客人信息表单
  - [ ] 价格计算器
  - [ ] 可用性实时检查
- [ ] 预订详情页面 `src/app/bookings/[id]/page.js`
  - [ ] 完整预订信息
  - [ ] 状态变更历史
  - [ ] 客人信息管理
  - [ ] 操作按钮（确认、取消等）

### 4. 客户信息管理系统

#### API 端点实现

- [ ] 客户列表 API
  - [ ] `src/app/api/guests/route.js` (GET)
  - [ ] 支持搜索（姓名、电话）
  - [ ] 按预订状态过滤
- [ ] 客户详情 API
  - [ ] `src/app/api/guests/[id]/route.js` (GET)
  - [ ] 包含预订历史
- [ ] 更新客户信息 API
  - [ ] `src/app/api/guests/[id]/route.js` (PUT)
  - [ ] 隐私保护检查
- [ ] 客户数据导出 API
  - [ ] `src/app/api/guests/export/route.js` (GET)
  - [ ] CSV/Excel格式支持
  - [ ] 权限控制

#### 前端页面实现

- [ ] 客户列表页面 `src/app/guests/page.js`
  - [ ] 表格展示客户信息
  - [ ] 高级搜索功能
  - [ ] 批量操作功能
  - [ ] 导出功能按钮
- [ ] 客户详情页面 `src/app/guests/[id]/page.js`
  - [ ] 个人信息展示
  - [ ] 预订历史时间线
  - [ ] 编辑信息功能
  - [ ] 通讯记录（可选）

### 5. 通用组件开发

- [ ] 数据表格组件 `components/DataTable.js`
  - [ ] 排序功能
  - [ ] 分页功能
  - [ ] 列配置
  - [ ] 行选择
- [ ] 搜索组件 `components/SearchBar.js`
  - [ ] 实时搜索
  - [ ] 搜索历史
  - [ ] 高级筛选
- [ ] 日期组件
  - [ ] `components/DatePicker.js`
  - [ ] `components/DateRangePicker.js`
  - [ ] 本地化支持
- [ ] 状态组件
  - [ ] `components/StatusBadge.js`
  - [ ] 不同状态的颜色主题
- [ ] 模态框组件 `components/Modal.js`
  - [ ] 确认对话框
  - [ ] 表单模态框
  - [ ] 可定制大小

### 6. 数据验证和错误处理

- [ ] 前端表单验证
  - [ ] 使用 React Hook Form + Yup
  - [ ] 实时验证反馈
  - [ ] 自定义验证规则
- [ ] 后端数据验证
  - [ ] 创建验证模式文件
  - [ ] API输入清理
  - [ ] 错误响应标准化
- [ ] 错误边界组件
  - [ ] `components/ErrorBoundary.js`
  - [ ] 全局错误捕获
  - [ ] 错误上报机制

### 7. 业务逻辑优化

- [ ] 可用性检查算法
  - [ ] 日期冲突检测
  - [ ] 容量管理
  - [ ] 重复预订防止
- [ ] 价格计算引擎
  - [ ] 动态定价逻辑
  - [ ] 折扣管理
  - [ ] 税费计算
- [ ] 状态机实现
  - [ ] 预订状态流转
  - [ ] 自动状态更新
  - [ ] 异常状态处理

## 测试清单

- [ ] 套餐管理功能测试
  - [ ] CRUD操作完整性
  - [ ] 权限控制
  - [ ] 数据验证
- [ ] 预订功能测试
  - [ ] 预订流程完整性
  - [ ] 冲突检测准确性
  - [ ] 状态管理正确性
- [ ] 客户管理测试
  - [ ] 信息保护
  - [ ] 搜索功能
  - [ ] 导出功能
- [ ] API接口测试
  - [ ] 所有端点响应正确
  - [ ] 错误处理完善
  - [ ] 性能符合要求

## 完成标准

- [ ] 所有CRUD功能正常工作
- [ ] 数据验证和错误处理完善
- [ ] 用户界面友好易用
- [ ] API接口稳定可靠
- [ ] 通过所有测试用例

## 输出文件

- [ ] 完整的功能模块代码
- [ ] API接口文档
- [ ] 数据库迁移文件
- [ ] 测试用例代码
- [ ] 用户操作手册

## 预计时间

5-7天

## 依赖关系

需要完成批次2的用户认证系统

## 下一批次

完成后进入批次4：高级功能
