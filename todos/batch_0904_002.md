# 批次2：用户认证系统

## 批次概述

实现完整的用户认证功能，包括注册、登录、权限管理等核心认证机制。

## 任务清单

### 1. 数据库基础设置

- [ ] 数据库技术选择和安装
  - [ ] 选择数据库（PostgreSQL 推荐，SQLite 开发环境）
  - [ ] 安装和配置数据库
  - [ ] 测试数据库连接
- [ ] Prisma ORM 集成
  - [ ] 安装 Prisma CLI 和客户端
  - [ ] 初始化 Prisma 配置
  - [ ] 配置数据库连接字符串

### 2. 用户数据模型设计

- [ ] 创建 Prisma Schema
  - [ ] 设计用户表（users）

    ```prisma
    model User {
      id          String   @id @default(cuid())
      username    String   @unique
      email       String   @unique
      password    String
      role        Role     @default(GUEST)
      avatar      String?
      phone       String?
      created_at  DateTime @default(now())
      updated_at  DateTime @updatedAt
    }

    enum Role {
      ADMIN
      STAFF
      GUEST
    }
    ```

  - [ ] 设计会话表（sessions）用于JWT管理

- [ ] 数据库迁移
  - [ ] 运行 Prisma 迁移
  - [ ] 创建种子数据
  - [ ] 验证数据库表结构

### 3. 认证基础架构

- [ ] 认证工具安装和配置
  - [ ] 安装 bcryptjs（密码加密）
  - [ ] 安装 jsonwebtoken（JWT管理）
  - [ ] 安装 js-cookie（客户端cookie管理）
- [ ] 环境变量配置
  - [ ] JWT_SECRET 密钥
  - [ ] DATABASE_URL 连接
  - [ ] NEXTAUTH_URL 和 NEXTAUTH_SECRET
- [ ] 认证工具函数
  - [ ] 创建 `lib/auth.js`
    - [ ] 密码哈希函数
    - [ ] JWT 生成和验证
    - [ ] 权限检查函数

### 4. API路由实现

- [ ] 用户注册 API
  - [ ] 创建 `src/app/api/auth/register/route.js`
  - [ ] 实现输入验证（用户名、邮箱、密码强度）
  - [ ] 检查用户名和邮箱唯一性
  - [ ] 密码加密存储
  - [ ] 返回标准响应格式
- [ ] 用户登录 API
  - [ ] 创建 `src/app/api/auth/login/route.js`
  - [ ] 验证用户凭据
  - [ ] 生成 JWT Token
  - [ ] 设置安全Cookie
  - [ ] 返回用户信息（不含密码）
- [ ] 登出 API
  - [ ] 创建 `src/app/api/auth/logout/route.js`
  - [ ] 清除客户端Cookie
  - [ ] 令牌黑名单处理（可选）
- [ ] 用户信息获取 API
  - [ ] 创建 `src/app/api/auth/me/route.js`
  - [ ] JWT验证中间件
  - [ ] 返回当前用户信息

### 5. 认证中间件

- [ ] 创建认证中间件 `middleware.js`
  - [ ] JWT令牌验证
  - [ ] 保护的路由列表
  - [ ] 自动重定向逻辑
- [ ] 权限检查组件
  - [ ] 创建 `components/ProtectedRoute.js`
  - [ ] 角色权限验证
  - [ ] 未授权处理

### 6. 前端认证界面

- [ ] 登录页面完整实现
  - [ ] 创建登录表单组件
  - [ ] 表单验证（前端+后端）
  - [ ] 错误处理和显示
  - [ ] 登录成功后重定向
  - [ ] "记住我"功能
- [ ] 注册页面完整实现
  - [ ] 创建注册表单组件
  - [ ] 密码强度检查
  - [ ] 邮箱格式验证
  - [ ] 注册成功处理
- [ ] 用户状态管理
  - [ ] 创建 `contexts/AuthContext.js`
  - [ ] 全局用户状态
  - [ ] 登录状态持久化
  - [ ] 自动登录检查

### 7. 基础组件优化

- [ ] 表单组件开发
  - [ ] `components/Form/Input.js` - 通用输入组件
  - [ ] `components/Form/Button.js` - 按钮组件
  - [ ] `components/Form/FormError.js` - 错误显示组件
  - [ ] `components/Loading.js` - 加载状态组件
- [ ] 导航组件更新
  - [ ] 根据登录状态显示不同菜单
  - [ ] 用户头像和下拉菜单
  - [ ] 登出功能集成


### 8. 安全性实现

- [ ] 输入验证和清理
  - [ ] SQL注入防护
  - [ ] XSS防护
  - [ ] CSRF防护
- [ ] 密码安全
  - [ ] 密码复杂度要求
  - [ ] 密码重置功能（可选）
  - [ ] 登录尝试限制（可选）
- [ ] JWT安全配置
  - [ ] 令牌过期时间
  - [ ] 刷新令牌机制
  - [ ] 安全的Cookie设置

## 测试清单

- [ ] 注册功能测试
  - [ ] 正常注册流程
  - [ ] 重复用户名/邮箱处理
  - [ ] 无效输入处理
- [ ] 登录功能测试
  - [ ] 正确凭据登录
  - [ ] 错误凭据处理
  - [ ] 记住我功能
- [ ] 权限控制测试
  - [ ] 受保护页面访问控制
  - [ ] 自动重定向功能
  - [ ] 角色权限验证
- [ ] 安全性测试
  - [ ] 密码存储安全性
  - [ ] JWT令牌有效性
  - [ ] 会话管理

## 完成标准

- [ ] 用户可以正常注册和登录
- [ ] 受保护的路由正常工作
- [ ] 用户状态在刷新后保持
- [ ] 所有安全措施到位
- [ ] 通过所有测试用例

## 输出文件

- [ ] 完整的认证系统代码
- [ ] 数据库迁移文件
- [ ] 认证API文档
- [ ] 测试用例代码

## 预计时间

3-4天

## 依赖关系

需要完成批次1的基础搭建

## 下一批次

完成后进入批次3：核心CRUD功能
